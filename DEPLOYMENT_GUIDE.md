# Deployment Guide

This guide will help you deploy the Cycles application with the frontend on Netlify and the backend on Render.

## Prerequisites

- GitHub account
- Netlify account (free tier works)
- Render account (free tier works)
- Neon PostgreSQL database (or any PostgreSQL database)
- Redis instance (Render provides this)

---

## Part 1: Backend Deployment on Render

### Step 1: Set Up Database (Neon)

1. Go to [Neon Console](https://console.neon.tech/)
2. Create a new project
3. Copy your connection string (it looks like: `postgresql://user:password@host.neon.tech/dbname?sslmode=require`)
4. Keep this handy - you'll need it for Render

### Step 2: Push Code to GitHub

```bash
# If not already initialized
git init
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin https://github.com/YOUR_USERNAME/cycles.git
git push -u origin main
```

### Step 3: Deploy Backend on Render

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click **"New +"** â†’ **"Blueprint"**
3. Connect your GitHub repository
4. Render will detect the `render.yaml` file
5. Click **"Apply"**

### Step 4: Configure Environment Variables

In Render dashboard, go to your backend service and add these environment variables:

#### Required Variables:

```env
# Database
DATABASE_URL=postgresql://user:password@host.neon.tech/dbname?sslmode=require

# JWT Secrets (auto-generated by Render)
JWT_SECRET=<auto-generated>
JWT_REFRESH_SECRET=<auto-generated>

# M-Pesa Configuration (if using M-Pesa)
MPESA_CONSUMER_KEY=your_consumer_key
MPESA_CONSUMER_SECRET=your_consumer_secret
MPESA_PASSKEY=your_passkey
MPESA_SHORTCODE=your_shortcode
MPESA_CALLBACK_URL=https://your-backend.onrender.com/api/v1/wallet/mpesa/callback

# Redis (auto-configured by Render Redis service)
REDIS_HOST=<from-render-redis>
REDIS_PORT=6379
REDIS_PASSWORD=<from-render-redis>

# Email Configuration
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
EMAIL_FROM=noreply@cycles.com

# LiveKit (if using video calls)
LIVEKIT_API_KEY=your_api_key
LIVEKIT_API_SECRET=your_api_secret
LIVEKIT_WS_URL=wss://your-livekit-url

# Push Notifications (if using)
VAPID_PUBLIC_KEY=your_public_key
VAPID_PRIVATE_KEY=your_private_key
VAPID_SUBJECT=mailto:your-email@example.com
```

### Step 5: Run Database Migrations

After deployment, you need to run migrations. In Render:

1. Go to your backend service
2. Click **"Shell"** tab
3. Run these commands:

```bash
cd backend
npm run migrate:up
npm run seed:system-accounts
```

### Step 6: Verify Backend

Your backend should be running at: `https://your-backend.onrender.com`

Test the health endpoint:

```bash
curl https://your-backend.onrender.com/health
```

---

## Part 2: Frontend Deployment on Netlify

### Step 1: Install Netlify CLI (Optional)

```bash
npm install -g netlify-cli
```

### Step 2: Deploy to Netlify

#### Option A: Using Netlify Dashboard (Recommended)

1. Go to [Netlify Dashboard](https://app.netlify.com/)
2. Click **"Add new site"** â†’ **"Import an existing project"**
3. Connect to GitHub and select your repository
4. Netlify will auto-detect the `netlify.toml` configuration
5. Click **"Deploy site"**

#### Option B: Using Netlify CLI

```bash
cd frontend
netlify deploy --prod
```

### Step 3: Configure Environment Variables

In Netlify dashboard, go to **Site settings** â†’ **Environment variables** and add:

```env
# Backend API URL
NEXT_PUBLIC_API_URL=https://your-backend.onrender.com/api/v1

# WebSocket URL
NEXT_PUBLIC_WS_URL=https://your-backend.onrender.com

# LiveKit (if using video calls)
NEXT_PUBLIC_LIVEKIT_URL=wss://your-livekit-url
```

### Step 4: Redeploy

After adding environment variables:

1. Go to **Deploys** tab
2. Click **"Trigger deploy"** â†’ **"Clear cache and deploy site"**

### Step 5: Verify Frontend

Your frontend should be live at: `https://your-site.netlify.app`

---

## Part 3: Post-Deployment Configuration

### Update CORS Settings

In your backend code (`backend/src/main.ts`), update CORS to include your Netlify URL:

```typescript
app.enableCors({
  origin: ["http://localhost:3000", "https://your-site.netlify.app"],
  credentials: true,
});
```

### Update M-Pesa Callback URL

If using M-Pesa, update your callback URL in Safaricom portal to:

```
https://your-backend.onrender.com/api/v1/wallet/mpesa/callback
```

### Set Up Custom Domain (Optional)

#### For Netlify:

1. Go to **Domain settings**
2. Click **"Add custom domain"**
3. Follow DNS configuration instructions

#### For Render:

1. Go to your service settings
2. Click **"Custom Domain"**
3. Follow DNS configuration instructions

---

## Part 4: Monitoring & Maintenance

### Check Logs

**Render:**

- Go to your service â†’ **Logs** tab
- Real-time logs available

**Netlify:**

- Go to **Deploys** â†’ Click on a deploy â†’ **Deploy log**
- Function logs in **Functions** tab

### Database Backups

Set up automated backups in Neon:

1. Go to your Neon project
2. Navigate to **Settings** â†’ **Backups**
3. Enable automated backups

### Health Checks

Monitor your services:

- Backend: `https://your-backend.onrender.com/health`
- Frontend: `https://your-site.netlify.app`

---

## Troubleshooting

### Backend Issues

**Service won't start:**

- Check environment variables are set correctly
- Review logs in Render dashboard
- Verify DATABASE_URL is correct

**Database connection fails:**

- Ensure Neon database is running
- Check if IP restrictions are set in Neon
- Verify connection string format

**Redis connection fails:**

- Ensure Redis service is deployed
- Check REDIS_HOST and REDIS_PASSWORD are set

### Frontend Issues

**Build fails:**

- Check if all environment variables are set
- Review build logs in Netlify
- Ensure `@netlify/plugin-nextjs` is in package.json

**API calls fail:**

- Verify NEXT_PUBLIC_API_URL is correct
- Check CORS settings in backend
- Ensure backend is running

**Environment variables not working:**

- Must start with `NEXT_PUBLIC_` for client-side access
- Redeploy after adding new variables

---

## Cost Optimization

### Free Tier Limits

**Render:**

- Free tier: 750 hours/month
- Services spin down after 15 min of inactivity
- First request after spin-down takes ~30 seconds

**Netlify:**

- Free tier: 100GB bandwidth/month
- 300 build minutes/month

**Neon:**

- Free tier: 0.5GB storage
- 1 project

### Recommendations

1. **Keep services active:** Use a service like UptimeRobot to ping your backend every 5 minutes
2. **Optimize builds:** Use Netlify's build cache
3. **Database pooling:** Already configured in your DatabaseService
4. **Monitor usage:** Check dashboards regularly

---

## Security Checklist

- [ ] All secrets stored as environment variables
- [ ] CORS properly configured
- [ ] Database uses SSL (Neon does by default)
- [ ] JWT secrets are strong and unique
- [ ] Rate limiting enabled in backend
- [ ] HTTPS enforced on both frontend and backend
- [ ] Environment variables never committed to Git
- [ ] Database backups enabled
- [ ] Error messages don't expose sensitive info

---

## Quick Reference

### Important URLs

- **Frontend:** `https://your-site.netlify.app`
- **Backend API:** `https://your-backend.onrender.com/api/v1`
- **Health Check:** `https://your-backend.onrender.com/health`
- **Neon Console:** `https://console.neon.tech`
- **Render Dashboard:** `https://dashboard.render.com`
- **Netlify Dashboard:** `https://app.netlify.com`

### Common Commands

```bash
# Redeploy frontend
netlify deploy --prod

# View backend logs
# (Use Render dashboard)

# Run migrations
# (Use Render shell)
cd backend && npm run migrate:up

# Check deployment status
netlify status
```

---

## Support

If you encounter issues:

1. Check the logs in Render/Netlify dashboards
2. Review this guide's troubleshooting section
3. Verify all environment variables are set correctly
4. Ensure your database is accessible

---

**Deployment Complete! ðŸŽ‰**

Your application should now be live and accessible to users.
